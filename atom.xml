<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://fujianfei1991.github.io</id>
    <title>å­¦ä¹ è®°å½•</title>
    <updated>2020-08-13T01:50:40.647Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://fujianfei1991.github.io"/>
    <link rel="self" href="https://fujianfei1991.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://fujianfei1991.github.io/images/avatar.png</logo>
    <icon>https://fujianfei1991.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, å­¦ä¹ è®°å½•</rights>
    <entry>
        <title type="html"><![CDATA[nginx + php-fpm è°ƒä¼˜]]></title>
        <id>https://fujianfei1991.github.io/post/nginx-php-fpm-diao-you/</id>
        <link href="https://fujianfei1991.github.io/post/nginx-php-fpm-diao-you/">
        </link>
        <updated>2020-08-06T07:21:54.000Z</updated>
        <content type="html"><![CDATA[<h2 id="è¿›ç¨‹é€šä¿¡æ–¹å¼">è¿›ç¨‹é€šä¿¡æ–¹å¼</h2>
<blockquote>
<p>nginx å’Œ php-fpm çš„è¿›ç¨‹é—´é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼<br>
Aï¼šåŸºäº TCP çš„ï¼ŒIPåŠ ç«¯å£çš„æ–¹å¼ï¼Œå¯ä»¥è·¨æœåŠ¡å™¨<br>
Bï¼šæ˜¯ UNIX Domain Socketï¼Œä¸ç»è¿‡ç½‘ç»œï¼Œåªèƒ½ç”¨äº Nginx è·Ÿ PHP-FPM éƒ½åœ¨åŒä¸€æœåŠ¡å™¨çš„åœºæ™¯ï¼Œå…·ä½“ä½¿ç”¨å“ªç§å–å†³äºnginxå’Œphp-fpmçš„é…ç½®</p>
</blockquote>
<pre><code># æ–¹å¼A
php-fpm.conf: listen = 127.0.0.1:9000
nginx.conf: fastcgi_pass 127.0.0.1:9000;
# æ–¹å¼B
php-fpm.conf: listen = /tmp/php-fpm.sock
nginx.conf: fastcgi_pass unix:/tmp/php-fpm.sock;
</code></pre>
<p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå½“ä½¿ç”¨å•æœºçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨UNIX Domain Socket çš„æ–¹å¼æ›´å¥½ï¼Œæ¶‰åŠåˆ°å¤šå°æœºå™¨è½¬å‘çš„æ—¶å€™ï¼Œä½¿ç”¨TCPè¿›è¡Œç½‘ç»œé€šä¿¡çš„æ–¹å¼æ‰å¯ä»¥<br>
UNIX Domain Socket åœ¨é¢å¯¹é«˜å¹¶å‘çš„çš„æ—¶å€™ä¸å¤ªç¨³å®šï¼Œä¼šå‡ºç°å¤§é‡çš„502é”™è¯¯ï¼Œè¿™é‡Œæ˜¯ç”±äºå†…æ ¸çš„æœ€å¤§è¿æ¥æ•°å¯¼è‡´çš„<br>
é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<pre><code>connect() to unix:/tmp/php-cgi.sock failed (11: Resource temporarily unavailable) while connecting to upstream
</code></pre>
<h3 id="ä¼˜åŒ–æ–¹æ³•">ä¼˜åŒ–æ–¹æ³•</h3>
<p>æŸ¥çœ‹ç³»ç»Ÿå†…æ ¸å‚æ•°å¤§å°ï¼š</p>
<pre><code>[root@izbp1afvt32y9uri4c7x4tz ~]# cat /proc/sys/net/core/somaxconn
128
</code></pre>
<p>æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥è°ƒæ•´å†…æ ¸å‚æ•°</p>
<pre><code># /etc/sysctl.conf
net.unix.max_dgram_qlen = 4096
net.core.netdev_max_backlog = 4096
net.core.somaxconn = 4096
</code></pre>
<p>æŸ¥çœ‹80ç«¯å£å…è®¸è¿æ¥æ•°å¤§å°</p>
<pre><code>[root@izbp1afvt32y9uri4c7x4tz ~]# cat /proc/sys/net/core/somaxconn
Netid State      Recv-Q Send-Q     Local Address:Port                    Peer Address:Port
tcp   LISTEN     0      128                   *:80                                 *:*
</code></pre>
<p>ä¿®æ”¹ nginx  å’Œphp-fpm çš„ backlogå¤§å°ï¼Œnginxé»˜è®¤511</p>
<pre><code># nginx.conf
server{
  listen 80 default backlog=1024;
}
# php-fpm.conf
listen.backlog = 1024
</code></pre>
<p>è°ƒæ•´ä¹‹å UNIX Domain Socket åœ¨é¢å¯¹å¤§é‡å¹¶å‘çš„æ—¶å€™ä¹Ÿå¯ä»¥ç¨³å®šè¿è¡Œäº†<br>
å…³äº php-fpm å’Œ phpé…ç½®çš„è°ƒæ•´å¯ä»¥çœ‹ä¸‹ä¸‹é¢çš„æ–‡ç« </p>
<blockquote>
<p>https://juejin.im/post/6844903849132556296<br>
https://learnku.com/articles/18782<br>
https://blog.thinkphp.cn/843679</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[iptables + ipset å±è”½ç¦æ­¢å›½å¤–IPè®¿é—®]]></title>
        <id>https://fujianfei1991.github.io/post/iptables-ipset-ping-bi-jin-zhi-guo-wai-ip-fang-wen/</id>
        <link href="https://fujianfei1991.github.io/post/iptables-ipset-ping-bi-jin-zhi-guo-wai-ip-fang-wen/">
        </link>
        <updated>2020-07-31T03:11:39.000Z</updated>
        <content type="html"><![CDATA[<p>èµ·åˆé‡åˆ°è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸º <code>freeswitch</code> ç›—æ‰“çš„å‡ºç°ï¼Œé¢‘ç¹çš„ç›—æ‰“å½±å“å‘¼å«ä¸­å¿ƒçš„ä½¿ç”¨ã€‚è¿™é‡Œå¾ˆå¤šç›—æ‰“çš„IPæ¥æºå°±æ˜¯å›½å¤–çš„IPåœ°å€ï¼Œé‚£ä¹ˆç¦æ­¢å›½å¤–çš„IPåœ°å€å°±å¯ä»¥è§£å†³é—®é¢˜äº†</p>
<blockquote>
<p>ipsetæ˜¯iptablesçš„æ‰©å±•,å®ƒå…è®¸ä½ åˆ›å»º åŒ¹é…æ•´ä¸ªåœ°å€é›†åˆçš„è§„åˆ™ã€‚è€Œä¸åƒæ™®é€šçš„iptablesé“¾åªèƒ½å•IPåŒ¹é…, ipé›†åˆå­˜å‚¨åœ¨å¸¦ç´¢å¼•çš„æ•°æ®ç»“æ„ä¸­,è¿™ç§ç»“æ„å³æ—¶é›†åˆæ¯”è¾ƒå¤§ä¹Ÿå¯ä»¥è¿›è¡Œé«˜æ•ˆçš„æŸ¥æ‰¾ï¼Œé™¤äº†ä¸€äº›å¸¸ç”¨çš„æƒ…å†µ,æ¯”å¦‚é˜»æ­¢ä¸€äº›å±é™©ä¸»æœºè®¿é—®æœ¬æœºï¼Œä»è€Œå‡å°‘ç³»ç»Ÿèµ„æºå ç”¨æˆ–ç½‘ç»œæ‹¥å¡,IPsetsä¹Ÿå…·å¤‡ä¸€äº›æ–°é˜²ç«å¢™è®¾è®¡æ–¹æ³•,å¹¶ç®€åŒ–äº†é…ç½®.å®˜ç½‘ï¼šhttp://ipset.netfilter.org/</p>
</blockquote>
<p>è¿™é‡Œå°±æ˜¯åˆ©ç”¨<code>ipset</code>æ¥å°†å›½å†…çš„IPæ”¶é›†èµ·æ¥ï¼Œåªå¼€å‘å›½å†…çš„IPåœ°å€</p>
<h2 id="å®‰è£…-ipset">å®‰è£… IPSET</h2>
<p>å½“å‰ç¯å¢ƒå¦‚ä¸‹ï¼š</p>
<pre><code>[root@izbp1afvt32y9uri4c7x4tz ~]# cat /etc/redhat-release 
CentOS Linux release 7.8.2003 (Core)

$ yum install ipset     # å®‰è£…
</code></pre>
<h4 id="åˆ›å»º-ipé›†åˆ">åˆ›å»º IPé›†åˆ</h4>
<pre><code>$ ipset create mainland hash:net maxelem 65536
mainland : è¿™ä¸ªå°±æ˜¯å½“å‰é›†åˆçš„åç§°
hash : è¡¨ç¤ºä»¥hashæ–¹å¼å­˜å‚¨ä¿¡æ¯
net :  æŒ‡å®šå¯ä»¥å¾€é›†åˆä¸­æ·»åŠ IPæ®µæˆ–è€…IPåœ°å€
maxelem : è¡¨ç¤ºå¯ä»¥å­˜å‚¨æœ€å¤§çš„æ¡ç›®æ•°é‡ï¼Œè¿™é‡Œå°±æ˜¯ 65536
</code></pre>
<h4 id="ç¼–å†™è„šæœ¬è‡ªåŠ¨æ›´æ–°æ•°æ®åˆ°-ip-é›†åˆå½“ä¸­">ç¼–å†™è„šæœ¬è‡ªåŠ¨æ›´æ–°æ•°æ®åˆ° IP é›†åˆå½“ä¸­</h4>
<p>ä¿å­˜åœ¨ <code>/home/mainland.sh</code></p>
<pre><code>#!/usr/bin/env bash
wget --no-check-certificate -O- 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | awk -F\| '/CN\|ipv4/ { printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) }' &gt; /home/mainland.txt
ipset flush mainland
while read ip; do
    ipset add mainland $ip
done &lt; /home/mainland.txt
ipset save chnroute &gt; /home/mainland.conf
</code></pre>
<p>å¯ä»¥è®¾ç½®ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä¸æ–­çš„å»æ›´æ–°IPé›†åˆ</p>
<h2 id="é…ç½®-iptables-é™åˆ¶è®¿é—®">é…ç½® <code>iptables</code> é™åˆ¶è®¿é—®</h2>
<p>é…ç½®æŸä¸ªç«¯å£éœ€è¦ç¦æ­¢å›½å¤–è®¿é—®çš„è¯ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ <code>iptables</code> å½“ä¸­ç¦æ­¢äº†ç«¯å£çš„è®¿é—®ï¼Œå¹¶ä¸”é’ˆå¯¹ ipset çš„é›†åˆå¼€æ”¾æ¥å£ï¼Œä»¥ <code>8090</code> ç«¯å£ä¸ºä¾‹</p>
<pre><code>iptables -A INPUT -m set --match-set mainland src -p tcp --dport 8090 -j ACCEPT
iptables -A INPUT -m set --match-set mainland src -p udp --dport 8090 -j ACCEPT
iptables -A INPUT -p tcp --dport 8090 -j DROP
iptables -A INPUT -p udp --dport 8090 -j DROP
</code></pre>
<p>ä¿å­˜ä¹‹åï¼Œé‡è½½ä¸€ä¸‹ <code>iptables</code> è®©æ–°è§„åˆ™ç”Ÿæ•ˆ</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dockerfile åˆ›å»ºé•œåƒ]]></title>
        <id>https://fujianfei1991.github.io/post/dockerfile-chuang-jian-jing-xiang/</id>
        <link href="https://fujianfei1991.github.io/post/dockerfile-chuang-jian-jing-xiang/">
        </link>
        <updated>2020-07-28T07:57:52.000Z</updated>
        <content type="html"><![CDATA[<blockquote>
<p>ä½¿ç”¨Dockerfile æ¥æ„å»ºé•œåƒçš„æ—¶å€™å¿…é¡»è¦åŸºäºä¸€ä¸ªåŸºç¡€é•œåƒæ¥æ„å»ºï¼Œè¿™ä¹Ÿå°±æ˜¯æ¯ä¸ªDockerfileæ–‡ä»¶çš„å¼€å¤´å¿…é¡»æ˜¯ FROM æŒ‡ä»¤çš„åŸå› <br>
#Base image<br>
FROM centos</p>
</blockquote>
<p>è®¾ç½®dockerä¸»æœºè®¿é—®ç½‘ç»œ</p>
<pre><code># /etc/docker/daemon.json
&quot;dns&quot;: [&quot;100.100.2.136&quot;,&quot;100.100.2.138&quot;]

# ä¸Šé¢çš„å€¼åœ¨ /etc/resolv.confå½“ä¸­æŸ¥è¯¢
</code></pre>
<h2 id="å½“å‰ä½¿ç”¨nginx-æ¥åšæ ·ä¾‹åšè¯´æ˜">å½“å‰ä½¿ç”¨nginx æ¥åšæ ·ä¾‹åšè¯´æ˜</h2>
<p>åœ¨å†™ <code>Dockerfile</code>çš„æ—¶å€™æœ‰ä¸ªå‰æå°±æ˜¯å¿…é¡»ä¼šä½¿ç”¨æˆ–è€…å®‰è£…æŒ‡å®šçš„è½¯ä»¶ç­‰ï¼Œä¸ç„¶æ˜¯å†™ä¸å‡ºæ¥çš„<br>
ä¸‹é¢æ˜¯<code>nginx</code>çš„<code>Dockerfile</code> æ–‡ä»¶å†…å®¹</p>
<pre><code># åŸºç¡€é•œåƒ
FROM centos

# ä½œè€…ä¿¡æ¯
MAINTAINER 13260674703@163.com

# å°†å®‰è£…ç›®å½•è§£å‹åˆ° &quot;/usr/local/src&quot; ç›®å½•ï¼Œå¦‚æœæ˜¯&quot;.zip&quot;æ–‡ä»¶çš„è¯ï¼ŒADDæŒ‡ä»¤æ˜¯æ— æ³•è§£å‹çš„
ADD nginx-1.16.1.tar.gz /usr/local/src

# å®‰è£…ç›¸å…³ä¾èµ–ä»¥åŠæ·»åŠ ç”¨æˆ·
RUN yum install -y gcc gcc-c++ glibc make autoconf openssl openssl-devel 
RUN yum install -y libxslt-devel -y gd gd-devel pcre pcre-devel
RUN useradd -M -s /sbin/nologin nginx

# è½¬åˆ°nginxç›®å½•
WORKDIR /usr/local/src/nginx-1.16.1

# æ‰§è¡Œå®‰è£…æŒ‡ä»¤
RUN ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-file-aio --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module --with-http_image_filter_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_stub_status_module &amp;&amp; make &amp;&amp; make install

# nginxæ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œæ˜¯å¦è®©nignxè¿è¡Œäºåå°ï¼›è°ƒè¯•æ—¶åº”è¯¥ä¸ºoffï¼Œä½¿å¾—æ‰€æœ‰ä¿¡æ¯ç›´æ¥è¾“å‡ºåœ¨æ§åˆ¶å°
RUN echo &quot;daemon off;&quot; &gt;&gt; /usr/local/nginx/conf/nginx.conf

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PATH /usr/local/nginx/sbin:$PATH

# å®šä¹‰å‘å¤–æš´éœ²çš„ç«¯å£å·,å¤šä¸ªç«¯å£ç”¨ç©ºæ ¼åšé—´éš”,å¯åŠ¨å®¹å™¨çš„æ—¶å€™&quot;-p&quot;éœ€è¦ä½¿ç”¨æ­¤ç«¯å‘å¤–ç«¯æ˜ å°„.
EXPOSE 80

# å®šä¹‰æ§åˆ¶å°çš„è¿è¡Œå‘½ä»¤
CMD [&quot;nginx&quot;]
</code></pre>
<blockquote>
<p>Dockerfile å…¶ä»–è¯¦ç»†å‘½ä»¤å‚è€ƒï¼šhttps://docs.docker.com/engine/reference/builder/</p>
</blockquote>
<h2 id="æ„å»ºé•œåƒ">æ„å»ºé•œåƒ</h2>
<p>åœ¨<code>Dockerfile</code> æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œæ‰§è¡Œæ„å»ºæ“ä½œ</p>
<blockquote>
<p>æœ€åçš„ . ä»£è¡¨æœ¬æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡è·¯å¾„</p>
</blockquote>
<pre><code>$ docker build -t nginx:test .
</code></pre>
<p><img src="https://fujianfei1991.github.io/post-images/1595987633967.jpg" alt="" loading="lazy"><br>
ä»¥ä¸Šæ˜¾ç¤ºï¼Œè¯´æ˜å·²ç»æ„å»ºæˆåŠŸã€‚<br>
è¿è¡Œå¹¶æŸ¥çœ‹ç»“æœ<br>
<img src="https://fujianfei1991.github.io/post-images/1595988078086.png" alt="" loading="lazy"><br>
æ‰“å¼€ç½‘é¡µæŸ¥çœ‹<br>
<img src="https://fujianfei1991.github.io/post-images/1595988135680.png" alt="" loading="lazy"></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Docker åœ¨ Centos7 å®‰è£…ä½¿ç”¨]]></title>
        <id>https://fujianfei1991.github.io/post/docker-zai-centos7-an-zhuang-shi-yong/</id>
        <link href="https://fujianfei1991.github.io/post/docker-zai-centos7-an-zhuang-shi-yong/">
        </link>
        <updated>2020-07-27T03:01:20.000Z</updated>
        <content type="html"><![CDATA[<h4 id="å‰ææ¡ä»¶">å‰ææ¡ä»¶</h4>
<p><code>Docker</code> è¿è¡Œåœ¨ <code>Centos7</code> ä¸Šé¢ï¼Œå¯¹ç³»ç»Ÿå†…æ ¸æ˜¯æœ‰è¦æ±‚çš„<br>
è¦æ±‚ç³»ç»Ÿä¸º64ä½ï¼Œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ä½ <code>3.10</code> ä»¥ä¸Š</p>
<pre><code># æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬
[root@izbp1afvt32y9uri4c7x4tz ~]# uname -r
3.10.0-1062.9.1.el7.x86_64
</code></pre>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>** å®‰è£…ä¾èµ–åŒ… **</p>
<pre><code>sudo yum install -y yum-utils device-mapper-persistent-data lvm2 
</code></pre>
<p>** è®¾ç½®é•œåƒæº **<br>
è¿™é‡Œçš„è®¾ç½®é•œåƒæºåªæ˜¯ä¸ºäº†å®‰è£… <code>Docker</code> æ¥ä½¿ç”¨çš„ï¼Œä¸åé¢çš„é•œåƒä»“åº“éœ€è¦åŒºåˆ†å¼€æ¥</p>
<pre><code># é‡‡ç”¨é˜¿é‡Œäº‘é•œåƒæº
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre>
<p>** æ›´æ–°yum **</p>
<pre><code>$ sudo yum update
</code></pre>
<p>** æŸ¥çœ‹å¯ä»¥å®‰è£…çš„Dockerç‰ˆæœ¬ **</p>
<pre><code># å¦‚æœæ²¡æœ‰è®¾ç½®ä¸Šé¢çš„é•œåƒæºï¼Œæœ‰å¯èƒ½ä¼šæ²¡æœ‰ä»»ä½•åŒ…
$ yum list docker-ce --showduplicates | sort -r
</code></pre>
<p>** æŒ‡å®šç‰ˆæœ¬å®‰è£… **</p>
<pre><code>$ yum install docker-ce-18.03.1.ce-1.el7.centos
</code></pre>
<p>** æŸ¥çœ‹ç‰ˆæœ¬ **</p>
<pre><code>[root@izbp1afvt32y9uri4c7x4tz ~]# docker version
Client:
 Version:      18.03.1-ce
 API version:  1.37
 Go version:   go1.9.5
 Git commit:   9ee9f40
 Built:        Thu Apr 26 07:20:16 2018
 OS/Arch:      linux/amd64
 Experimental: false
 Orchestrator: swarm
Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?   # è¿™é‡Œæ˜¯ç”±äºDockeræ²¡æœ‰è¿è¡Œæ‰ä¼šå‡ºç°è¿™ä¸ªæé†’
</code></pre>
<h2 id="docker-ç”¨æˆ·è®¾ç½®"><code>Docker</code> ç”¨æˆ·è®¾ç½®</h2>
<p>ç”±äº<code>Docker</code> éœ€è¦è¿è¡Œåœ¨<code>root</code>æˆ–è€…<code>docker</code> è¿™ä¸ªç”¨æˆ·ç»„ä¸­çš„ç”¨æˆ·ä¸‹é¢ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®ä¸€ä¸‹ç”¨æˆ·ï¼Œæ¯•ç«Ÿä½¿ç”¨rootè¿è¡Œè¿˜æ˜¯ä¸å¤ªåˆé€‚ï¼Œè€ƒè™‘åˆ°å®‰å…¨æ€§çš„é—®é¢˜<br>
** è®¾ç½®ç”¨æˆ· **</p>
<pre><code>$ useradd docker   # æ·»åŠ ç”¨æˆ·docker
$ passwd docker    # è®¾ç½®ç”¨æˆ·dockerçš„å¯†ç 

# æ·»åŠ åˆ°dockerç”¨æˆ·ç»„ä¸æŸ¥çœ‹
$ sudo usermod -aG docker npoulton    # å°†npoultonç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„
$ cat /etc/group | grep docker     # æŸ¥çœ‹æ“ä½œæ˜¯å¦æˆåŠŸ
docker:x:999:npoulton
</code></pre>
<h2 id="docker-æ“ä½œå‘½ä»¤"><code>Docker</code> æ“ä½œå‘½ä»¤</h2>
<pre><code># å¯åŠ¨docker
$ sudo service docker start   # service å‘½ä»¤çš„ç”¨æ³•
$ sudo systemctl start docker     # systemctl å‘½ä»¤çš„ç”¨æ³•
</code></pre>
<pre><code># é‡å¯
$ sudo service docker restart   # service æ–¹å¼
$ sudo systemctl restart docker   # systemctl å‘½ä»¤çš„æ–¹å¼
</code></pre>
<h2 id="ä¿®æ”¹é•œåƒæº">ä¿®æ”¹é•œåƒæº</h2>
<p>æ–°ç‰ˆçš„ Docker ä½¿ç”¨ /etc/docker/daemon.jsonï¼ˆLinuxï¼‰<br>
ä¸Šé¢çš„ <code>daemon.json</code> æ˜¯é•œåƒé…ç½®æ–‡ä»¶ï¼ˆæ²¡æœ‰è¯¥æ–‡ä»¶çš„è¯ï¼Œè¯·æ–°å»ºä¸€ä¸ªï¼‰ï¼š</p>
<pre><code>{
  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;]
}
</code></pre>
<p>è®¾ç½®å¥½ä¹‹åéœ€è¦é‡å¯ä¸€ä¸‹æœåŠ¡å³å¯</p>
<pre><code>$ sudo service docker restart
</code></pre>
<h2 id="å…³äºimageé•œåƒæ–‡ä»¶">å…³äº<code>image</code>é•œåƒæ–‡ä»¶</h2>
<p>è¿™é‡Œå¼•ç”¨é˜®ä¸€å³°å¾®åšä¸Šé¢çš„è§£é‡Šè¯´æ˜</p>
<blockquote>
<p>Docker æŠŠåº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–ï¼Œæ‰“åŒ…åœ¨ image æ–‡ä»¶é‡Œé¢ã€‚åªæœ‰é€šè¿‡è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰èƒ½ç”Ÿæˆ Docker å®¹<br>
å™¨ã€‚image æ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯å®¹å™¨çš„æ¨¡æ¿ã€‚Docker æ ¹æ® image æ–‡ä»¶ç”Ÿæˆå®¹å™¨çš„å®ä¾‹ã€‚åŒä¸€ä¸ª image<br>
æ–‡ä»¶ï¼Œå¯ä»¥ç”Ÿæˆå¤šä¸ªåŒæ—¶è¿è¡Œçš„å®¹å™¨å®ä¾‹ã€‚<br>
image æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®é™…å¼€å‘ä¸­ï¼Œä¸€ä¸ª image æ–‡ä»¶å¾€å¾€é€šè¿‡ç»§æ‰¿å¦ä¸€ä¸ª image æ–‡ä»¶ï¼ŒåŠ ä¸Šä¸€äº›<br>
æ€§åŒ–è®¾ç½®è€Œç”Ÿæˆã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä½ å¯ä»¥åœ¨ Ubuntu çš„ image åŸºç¡€ä¸Šï¼Œå¾€é‡Œé¢åŠ å…¥ Apache æœåŠ¡å™¨ï¼Œå½¢<br>
æˆä½ çš„ imageã€‚<br>
image æ–‡ä»¶æ˜¯é€šç”¨çš„ï¼Œä¸€å°æœºå™¨çš„ image æ–‡ä»¶æ‹·è´åˆ°å¦ä¸€å°æœºå™¨ï¼Œç…§æ ·å¯ä»¥ä½¿ç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†èŠ‚<br>
çœæ—¶é—´ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨åˆ«äººåˆ¶ä½œå¥½çš„ image æ–‡ä»¶ï¼Œè€Œä¸æ˜¯è‡ªå·±åˆ¶ä½œã€‚å³ä½¿è¦å®šåˆ¶ï¼Œä¹Ÿåº”è¯¥åŸºäºåˆ«<br>
äººçš„ image æ–‡ä»¶è¿›è¡ŒåŠ å·¥ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹åˆ¶ä½œã€‚<br>
ä¸ºäº†æ–¹ä¾¿å…±äº«ï¼Œimage æ–‡ä»¶åˆ¶ä½œå®Œæˆåï¼Œå¯ä»¥ä¸Šä¼ åˆ°ç½‘ä¸Šçš„ä»“åº“ã€‚Docker çš„å®˜æ–¹ä»“åº“ Docker Hub<br>
æ˜¯æœ€é‡è¦ã€æœ€å¸¸ç”¨çš„ image ä»“åº“ã€‚æ­¤å¤–ï¼Œå‡ºå”®è‡ªå·±åˆ¶ä½œçš„ image æ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚<br>
** å…³äº<code>image</code>çš„éƒ¨åˆ†æ“ä½œè¯´æ˜ **</p>
</blockquote>
<pre><code># æŸ¥æ‰¾é•œåƒï¼Œä¾‹å¦‚nginxé•œåƒ
$ docker search nginx
# æ‹‰å–é•œåƒï¼Œä¾‹å¦‚nginx
$ docker pull nginx
# æœ¬åœ°é•œåƒåˆ—è¡¨æŸ¥çœ‹é•œåƒï¼Œä¾‹å¦‚nginx
$ docker image nginx
# åˆ—å‡ºæœ¬æœºæ‰€ä»¥ image æ–‡ä»¶
$ docker image ls
# åˆ é™¤ image æ–‡ä»¶
$ docker image rm [imageName]
</code></pre>
<h2 id="å…³äºå®¹å™¨æ–‡ä»¶">å…³äºå®¹å™¨æ–‡ä»¶</h2>
<p>image æ–‡ä»¶ç”Ÿæˆçš„å®¹å™¨å®ä¾‹ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œç§°ä¸ºå®¹å™¨æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦å®¹å™¨ç”Ÿæˆï¼Œå°±ä¼šåŒæ—¶å­˜åœ¨ä¸¤ä¸ªæ–‡ä»¶ï¼š image æ–‡ä»¶å’Œå®¹å™¨æ–‡ä»¶ã€‚è€Œä¸”å…³é—­å®¹å™¨å¹¶ä¸ä¼šåˆ é™¤å®¹å™¨æ–‡ä»¶ï¼Œåªæ˜¯å®¹å™¨åœæ­¢è¿è¡Œè€Œå·²ã€‚</p>
<pre><code>$ docker ps -a         ã€€ã€€ã€€ã€€ã€€//  åˆ—å‡ºæ‰€æœ‰çš„å®¹å™¨
$ docker stop $IMAGE_ID   ã€€ // åœæ­¢å®¹å™¨
$ docker rm  $IMAGE_ID  ã€€ã€€// åˆ é™¤å®¹å™¨
$ docker ps      // æŸ¥çœ‹æ‰€æœ‰æ­£åœ¨è¿è¡Œå®¹å™¨
$ docker stop containerId    // containerId æ˜¯å®¹å™¨çš„ID
$ docker ps -a     // æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
$ docker ps -a -q    // æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ID
$ docker stop $(docker ps -a -q)   // stopåœæ­¢æ‰€æœ‰å®¹å™¨
$ docker rm $(docker ps -a -q)     // removeåˆ é™¤æ‰€æœ‰å®¹å™¨
</code></pre>
<h2 id="åŸºæœ¬æ ·ä¾‹">åŸºæœ¬æ ·ä¾‹</h2>
<blockquote>
<p>ä»¥ <code>nginx</code> ä¸ºä¾‹</p>
</blockquote>
<pre><code># å…ˆæ‹‰å–nginx
$ docker pull nginx
# é•œåƒä¸­æŸ¥çœ‹
$ docker images
</code></pre>
<p>** ä½¿ç”¨nginxé•œåƒå¼€å¯nginxåº”ç”¨å®¹å™¨ **</p>
<pre><code># è¿”å›
[root@izbp1afvt32y9uri4c7x4tz ~]# docker run -p 8090:80 -d nginx
25579676e9ee014a1f54cc31816aa871462ba20e3923d86a46227543cae8cb00
</code></pre>
<p>å½“å‰å®¹å™¨è¿è¡Œèµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°å®¹å™¨å½“ä¸­ï¼ŒæŸ¥çœ‹å¯¹åº”çš„æ–‡ä»¶è¿è¡Œä»¥åŠé…ç½®æƒ…å†µ</p>
<pre><code># è¿›å…¥åˆ°å®¹å™¨é‡Œé¢
[root@izbp1afvt32y9uri4c7x4tz ~]# docker exec -it 25579676e9ee bash  
root@25579676e9ee:/# 
# å› ä¸ºå½“å‰æˆ‘çš„é•œåƒå½“ä¸­æ²¡æœ‰å®‰è£…vimä¹‹ç±»çš„ç¼–è¾‘å™¨ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥æŸ¥çœ‹æ–‡ä»¶é…ç½®ä¿¡æ¯
# æŸ¥çœ‹é…ç½®ä¿¡æ¯
root@25579676e9ee:/# cd /etc/nginx/conf.d/
root@25579676e9ee:/etc/nginx/conf.d# ls
default.conf
</code></pre>
<blockquote>
<p>ç„¶åä½¿ç”¨ctrl + p + qé€€å‡ºå®¹å™¨ï¼Œä½¿ç”¨exitçš„è¯ä¼šè®©å®¹å™¨åœæ­¢<br>
å› ä¸ºå®¹å™¨é‡Œé¢æ–‡ä»¶æ— æ³•ç¼–è¾‘ï¼Œæ‰€ä»¥å¯ä»¥å¤åˆ¶å‡ºæ¥è¿›è¡Œç¼–è¾‘<br>
ä½¿ç”¨ä¸“ç”¨çš„å¤åˆ¶å‘½ä»¤å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å®¿ä¸»æœºï¼Œç„¶ååœ¨å®¿ä¸»æœºè¿›è¡Œç¼–è¾‘</p>
</blockquote>
<pre><code># å¤åˆ¶å‡ºæ¥
[root@localhost docker]# docker cp 25579676e9ee:/etc/nginx/conf.d/default.conf ./default.conf
# ç¼–è¾‘å¥½çš„æ–‡ä»¶å†å¤åˆ¶åˆ°å®¹å™¨å½“ä¸­
[root@localhost docker]# docker cp ./default.conf 25579676e9ee:/etc/nginx/conf.d/default.conf
</code></pre>
<p>è¿›å…¥åˆ°å®¹å™¨ä¸­ï¼Œé‡æ–°è½½å…¥nginxé…ç½®æ–‡ä»¶</p>
<pre><code>[root@localhost docker]# docker exec -it 25579676e9ee bash
root@3218b3ad4e47:/# service nginx reload
[ ok ] Reloading nginx: nginx.
root@3218b3ad4e47:/#
</code></pre>
<blockquote>
<p>å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šæ¶‰åŠåˆ°è¯¸å¤šçš„å‘½ä»¤ä»¥åŠå‚æ•°é…ç½®é¡¹ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š<br>
https://docs.docker.com/engine/reference/commandline/run/<br>
åœ¨å¯åŠ¨çš„æ—¶å€™è¿˜å¯ä»¥é€šè¿‡runå‘½ä»¤çš„å‚æ•°é…ç½®å¾ˆå¤šæŒ‚è½½ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†è¯´æ˜äº†ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹è¿æ¥ï¼š<br>
https://www.cnblogs.com/saneri/p/11799865.html</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ElK å®‰è£…ä½¿ç”¨ ä¸ elasticsearch-php æ‰©å±•ä½¿ç”¨]]></title>
        <id>https://fujianfei1991.github.io/post/elasticsearch/</id>
        <link href="https://fujianfei1991.github.io/post/elasticsearch/">
        </link>
        <updated>2020-07-18T02:32:12.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p><code>mysql</code> åœ¨5.6ä»¥å‰ï¼Œåªæœ‰<code>MySIAM</code>æ”¯æŒå…¨æ–‡æ£€ç´¢ï¼Œä½†æ˜¯ä¸æ”¯æŒç´¢å¼•ï¼Œä»5.6ä»¥å <code>InnoDB</code> å¼€å§‹æ”¯æŒå…¨æ–‡æ£€ç´¢ï¼Œä»5.7.6å¼€å§‹æ”¯æŒä¸­æ–‡åˆ†è¯ï¼Œä½†æ˜¯æ­£åœ¨åœ¨é¡¹ç›®ä¸Šåº”ç”¨çš„æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¸­æ–‡åˆ†è¯ä¸å‡†ç¡®ï¼Œæ€§èƒ½ä¸é«˜ï¼Œæ•°æ®é‡ä¸å¤§ï¼Œå› è€Œé‡‡ç”¨ <code>elasticsearch</code> è¿™ç§å…¨æ–‡æ£€ç´¢æ’ä»¶<br>
<code>Elasticsearch</code> ç³»åˆ—äº§å“å¯¹ç…§è¡¨</p>
<pre><code>https://www.elastic.co/cn/support/matrix#matrix_compatibility
</code></pre>
<p>åœ¨<code>Elasticsearch</code> å½“ä¸­æ²¡æœ‰è¡¨çš„æ¦‚å¿µï¼Œå¯¹åº”å…³ç³»æœ‰å¦å¤–çš„ç»“æ„ä½“ï¼Œå¯¹ç…§å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>å…³ç³»å‹æ•°æ®åº“ï¼ˆæ¯”å¦‚Mysqlï¼‰</th>
<th>éå…³ç³»å‹æ•°æ®åº“ï¼ˆElasticsearchï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®åº“ Database</td>
<td>ç´¢å¼• Index</td>
</tr>
<tr>
<td>è¡¨ Table</td>
<td>ç±»å‹ Type</td>
</tr>
<tr>
<td>æ•°æ®è¡Œ Row</td>
<td>æ–‡æ¡£ Document</td>
</tr>
<tr>
<td>æ•°æ®åˆ— Column</td>
<td>å­—æ®µ Field</td>
</tr>
<tr>
<td>çº¦æŸ Schema</td>
<td>æ˜ å°„ Mapping</td>
</tr>
</tbody>
</table>
<h4 id="åŸç†å‚è€ƒ">åŸç†å‚è€ƒ</h4>
<pre><code>https://developer.51cto.com/art/201904/594615.htm
https://www.cnblogs.com/dreamroute/p/8484457.html
</code></pre>
<h2 id="å®‰è£…-elasticsearch">å®‰è£… <code>Elasticsearch</code></h2>
<p><code>elasticsearch</code> æ˜¯åŸºäº <code>java8</code> ä»¥ä¸Šçš„ç¯å¢ƒå®‰è£…çš„ï¼Œæ‰€ä»¥éœ€è¦æ”¯æŒå…ˆå®‰è£… <code>java8</code></p>
<pre><code># å®‰è£…java8
$ yum install java-1.8.0.-openjdk* -y

# å®‰è£… elasticsearch
$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.16.zip
$ unzip elasticsearch-5.6.16.zip
$ cd elasticsearch-5.6.16/

# å› ä¸ºelasticsearchä¸èƒ½åœ¨rootè´¦æˆ·ä¸‹è¿è¡Œï¼Œæ‰€ä»¥çš„ä¿®æ”¹è´¦æˆ·
$ useradd  hadoop
$ passwd    hadoop
$ su hadoop

// ç›®å½•æƒé™ä¹Ÿæ˜¯æœ‰å½±å“çš„ï¼Œæ³¨æ„ä¿®æ”¹ç›®å½•æƒé™
// è¿è¡Œ elasticsearch
// elasticsearchå½“å‰5.6ç‰ˆæœ¬çš„è¿è¡Œå†…å­˜æ˜¯2Gï¼Œéœ€è¦è·Ÿä½ è‡ªå·±çš„ç³»ç»Ÿæƒ…å†µåšè°ƒæ•´
$ vim config/jvm.options
. . .    # è°ƒæ•´å¦‚ä¸‹ä¸¤ä¸ªå‚æ•°å¤§å°
-Xms1g
-Xmx1g
. . .

$ ./elasticsearch
//é»˜è®¤æ˜¯åœ¨ç«¯å£9200ä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¿é—®è¿™ä¸ªç«¯å£å°±ä¼šè¿”å›å¦‚ä¸‹ä¿¡æ¯
[root@localhost ~]# curl localhost:9200
{
  &quot;name&quot; : &quot;pUVGKF5&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;YuHh_UCqSGCNn7El3U0DVQ&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;5.6.16&quot;,
    &quot;build_hash&quot; : &quot;3a740d1&quot;,
    &quot;build_date&quot; : &quot;2019-03-13T15:33:36.565Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;6.6.1&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
# è‡³æ­¤å®‰è£…æˆåŠŸ
</code></pre>
<blockquote>
<p>Elasticsearch åœ¨ä½¿ç”¨ supervisor å¯åŠ¨çš„æ—¶å€™ï¼Œéœ€è¦æ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶</p>
</blockquote>
<pre><code># $ES_HOME/config/elasticsearch.yml
network.host: 0.0.0.0
http.port: 9200
transport.host: localhost
transport.tcp.port: 9300
</code></pre>
<p>å¦å¤– <code>supervisor</code> é‡Œé¢çš„é…ç½®å¦‚ä¸‹</p>
<pre><code># elasticsearch.conf
[program:elasticsearch]
command=/usr/local/elasticsearch/bin/elasticsearch
directory=/usr/local/elasticsearch/bin
user=hadoop
numprocs=1
priority=1
autostart=true
startsecs=10
satrtretries=3
autorestart=true
stopasgroup=true
killasgroup=true
redirect_stderr=true
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stdout_logfile=/var/log/supervisor/elasticsearch.out.log
stderr_logfile=/var/log/supervisor/elasticsearch.err.log
</code></pre>
<h2 id="æ•°æ®åŒæ­¥">æ•°æ®åŒæ­¥</h2>
<p>å†å²æ•°æ®å­˜æ”¾åœ¨ <code>MySQL</code> å½“ä¸­å°±æ¶‰åŠåˆ°åŒæ­¥çš„é—®é¢˜<br>
åŒæ­¥å·¥å…·ç”±å®˜æ–¹æä¾›çš„ <code>logstash</code> ä¸ æ·˜å®çš„ <code>canal</code>ï¼Œå…·ä½“çš„å·®å¼‚è¿™é‡Œä¸åšæè¿°äº†ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>logstash</code></p>
<h4 id="logstashå®‰è£…">logstashå®‰è£…</h4>
<p>é¦–å…ˆå»å®˜æ–¹ä¸‹è½½å¯¹åº”è½¯ä»¶ï¼Œè¿™ä¸ªè·Ÿ <code>elasticsearch</code> ç‰ˆæœ¬æ˜¯å¯¹åº”çš„ï¼Œæ‰€ä»¥ä¸‹è½½çš„æ—¶å€™éœ€è¦çœ‹ä¸‹ç‰ˆæœ¬å·</p>
<pre><code>// logstash-5.6.16.zip ä¸‹è½½æœ‰ç‚¹æ…¢
$ wget https://artifacts.elastic.co/downloads/logstash/logstash-5.6.16.zip 
$ unzip logstash-5.6.16.zip
// å¯ä»¥è½¬ç§»åˆ°è·Ÿ elasticsearch åŒçº§ç›®å½•ï¼Œæˆ‘è¿™é‡Œæ˜¯æ”¾åœ¨ srcç›®å½•ä¸‹é¢
$ mv logstash-5.6.16 /usr/local/logstash
</code></pre>
<h4 id="å®‰è£…logstash-è¾“å…¥ä¸è¾“å‡ºçš„æ’ä»¶">å®‰è£…logstash è¾“å…¥ä¸è¾“å‡ºçš„æ’ä»¶</h4>
<p>å®‰è£… <code>jdbc</code> å’Œ <code>elasticsearch</code> æ’ä»¶ï¼Œè¿™ä¸¤ä¸ªæ’ä»¶åˆ†åˆ«è¿æ¥ <code>MySQL</code> ä¸ <code>Elasticsearch</code></p>
<pre><code>$ bin/logstash-plugin install logstash-input-jdbc   // å®‰è£…æ¯”è¾ƒæ…¢
$ bin/logstash-plugin install logstash-output-elasticsearch
</code></pre>
<h4 id="å®‰è£…-mysql-å¯¹æ¥åˆ°-logstash-çš„é©±åŠ¨">å®‰è£… MySQL å¯¹æ¥åˆ° logstash çš„é©±åŠ¨</h4>
<pre><code>$ wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.46.zip
$ unzip mysql-connector-java-5.1.46.zip
// æ”¾åˆ° logstash çš„configç›®å½•é‡Œé¢
$ mv mysql-connector-java-5.1.46 /usr/local/logstash/config/mysql-connector-java
</code></pre>
<p>ä¸Šé¢çš„æ’ä»¶éƒ½å®‰è£…å®Œæˆä¹‹åï¼Œéœ€è¦ç”Ÿæˆ logstash å¯¹åº” <code>MySQL</code> å’Œ <code>Elasticsearch</code> çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶æ”¾ç½®åœ¨ <code>logstash</code> çš„é…ç½®æ–‡ä»¶ç›®å½• <code>config</code> å½“ä¸­ï¼Œæ–‡ä»¶åéšä¾¿å–ï¼Œ<code>sync_table.conf</code>ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š<br>
psï¼šè¿™é‡Œé¢æ¶‰åŠåˆ°äº†ä¸¤ä¸ªè¡¨çš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¡«å†™äº†ä¸¤ä¸ªé…ç½®ä¿¡æ¯</p>
<pre><code>input {
  jdbc {
    jdbc_driver_library =&gt; &quot;./config/mysql-connector-java/mysql-connector-java-5.1.46-bin.jar&quot;
    jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;
    jdbc_connection_string =&gt; &quot;jdbc:mysql://127.0.0.1:3306/yiren&quot;
    jdbc_user =&gt; &quot;root&quot;
    jdbc_password =&gt; &quot;e-line2019&quot;
    schedule =&gt; &quot;* * * * *&quot;
    statement =&gt; &quot;SELECT * FROM task_sales_source WHERE update_time &gt;= :sql_last_value&quot;
    use_column_value =&gt; true
    tracking_column_type =&gt; &quot;timestamp&quot;
    tracking_column =&gt; &quot;update_time&quot;
    clean_run =&gt; false
    last_run_metadata_path =&gt; &quot;last_source_id.txt&quot;
    type =&gt; &quot;task_sales_source&quot;
    tags =&gt; &quot;task_sales_source&quot;
  }
  jdbc {
    jdbc_driver_library =&gt; &quot;./config/mysql-connector-java/mysql-connector-java-5.1.46-bin.jar&quot;
    jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;
    jdbc_connection_string =&gt; &quot;jdbc:mysql://127.0.0.1:3306/yiren&quot;
    jdbc_user =&gt; &quot;root&quot;
    jdbc_password =&gt; &quot;e-line2019&quot;
    schedule =&gt; &quot;* * * * *&quot;
    statement =&gt; &quot;SELECT * FROM task_source_extend WHERE update_time &gt;= :sql_last_value&quot;
    use_column_value =&gt; true
    tracking_column_type =&gt; &quot;timestamp&quot;
    tracking_column =&gt; &quot;update_time&quot;
    clean_run =&gt; false
    last_run_metadata_path =&gt; &quot;last_extend_id.txt&quot;
    type =&gt; &quot;task_source_extend&quot;
    tags =&gt; &quot;task_source_extend&quot;
  }
}

output {
  if [type] == &quot;task_sales_source&quot;{
        elasticsearch {
            hosts =&gt; &quot;127.0.0.1:9200&quot;  
            index =&gt; &quot;task_sales_source&quot;  
            document_id =&gt; &quot;%{id}&quot;
        }
    }
    if [type] == &quot;task_source_extend&quot;{
        elasticsearch {
            hosts =&gt; &quot;127.0.0.1:9200&quot;
            index =&gt; &quot;task_source_extend&quot;  
            document_id =&gt; &quot;%{id}&quot;
        }
    }
  # elasticsearch {
  #   hosts =&gt; [&quot;127.0.0.1:9200&quot;]
  #   index =&gt; &quot;users&quot;
  #   document_id =&gt; &quot;%{id}&quot;
  #   document_type =&gt; &quot;users&quot;
  # }
  stdout {
      codec =&gt; json_lines
  }
}
</code></pre>
<h4 id="ä»¥é…ç½®æ–‡ä»¶å¯åŠ¨">ä»¥é…ç½®æ–‡ä»¶å¯åŠ¨</h4>
<pre><code>$ ./bin/logstash -f ./config/sync_table.conf
</code></pre>
<p>è¿™æ ·å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„åŒæ­¥è®°å½•æƒ…å†µï¼Œé»˜è®¤æ˜¯æ¯åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥è®¾å®šåŒæ­¥æ—¶é—´<br>
<img src="https://fujianfei1991.github.io/post-images/1595229302517.jpg" alt="" loading="lazy"></p>
<h4 id="æ—¶åŒºé—®é¢˜">æ—¶åŒºé—®é¢˜</h4>
<p>ç”±äº <code>logstash</code> æœ¬èº«é‡‡å–çš„æ˜¯ UTCæ—¶åŒºï¼Œæ‰€ä»¥éœ€è¦å¯¹è·å–çš„æ—¶é—´ +8 å°æ—¶<br>
åœ¨ <code>sync_table.conf</code> å¢åŠ å¦‚ä¸‹é…ç½®</p>
<pre><code># sync_table.conf
. . .
filter {
  ruby { 
    code =&gt; &quot;event.set('create_time', event.get('create_time').time.localtime + 8*60*60)&quot;
  }
  ruby { 
    code =&gt; &quot;event.set('update_time', event.get('update_time').time.localtime + 8*60*60)&quot;
  }
}
. . .
</code></pre>
<h2 id="kibana-ä½¿ç”¨">kibana ä½¿ç”¨</h2>
<p>å€ŸåŠ© <code>kibana</code> æ¥å®ç°å¯¹ <code>Elasticsearch</code> çš„æ•°æ®å¯è§†åŒ–æŸ¥çœ‹</p>
<h4 id="å®‰è£…">å®‰è£…</h4>
<pre><code>$ wget wget https://artifacts.elastic.co/downloads/kibana/kibana-5.6.16-linux-x86_64.tar.gz
# å¯¹æ¯”æ•°æ®åŒ…ï¼Œè¿”å›hashå€¼ï¼Œä¸å®˜ç½‘çš„åŒ…æ–‡ä»¶å¯¹æ¯”
$ sha1sum kibana-5.6.16-linux-x86_64.tar.gz   
$ tar -xzf kibana-5.6.16-linux-x86_64.tar.gz
$ mv kibana-5.6.16-linux-x86_64 /usr/local/kibana
$ cd /usr/local/kinaba
</code></pre>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹ï¼Œéœ€è¦å¼€å¯å…¬ç½‘è®¿é—®æƒé™çš„æ—¶å€™ï¼Œéœ€è¦æ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶<code>kibana.yml</code></p>
<pre><code># config/kibana.yml
. . .
$ server.port: 5601
$ server.host: &quot;0.0.0.0&quot;
. . .
</code></pre>
<p>å¯åŠ¨</p>
<pre><code>$ ./bin/kibana
</code></pre>
<p>è¿™æ ·å°±å¯ä»¥åœ¨å…¬ç½‘ä¸Šè®¿é—®<code>kibana</code> çš„webç®¡ç†ç•Œé¢</p>
<h4 id="åŸºç¡€é…ç½®">åŸºç¡€é…ç½®</h4>
<p>æ·»åŠ  <code>index</code> (æ·»åŠ ç´¢å¼•ï¼Œè¿™é‡Œçš„ç´¢å¼•å¯¹åº”çš„å°±æ˜¯MySQLå½“ä¸­çš„åº“)<br>
<code>Management</code> =&gt; <code>Index Patterns</code> =&gt; <code>Create Index Pattern</code> =&gt; <code>Index pattern</code> =&gt; <code>Time Filter field name</code> é€‰æ‹© <code>I don't want to use ths Time Filter</code><br>
æŸ¥çœ‹ <code>Discover</code><br>
<img src="https://fujianfei1991.github.io/post-images/1595230977809.jpg" alt="" loading="lazy"></p>
<h4 id="è‡³æ­¤elkå…¨å¥—çš„å®‰è£…å®Œæˆ">** è‡³æ­¤ï¼ŒELKå…¨å¥—çš„å®‰è£…å®Œæˆ **</h4>
<h2 id="elasticsearch-php-å®‰è£…ä½¿ç”¨"><code>Elasticsearch-php</code> å®‰è£…ä½¿ç”¨</h2>
<p><code>elasticsearch</code> å®˜æ–¹æœ‰æ”¯æŒ PHP çš„åº“ï¼Œä½¿ç”¨ <code>composer</code> å®‰è£…å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ³¨æ„ç‰ˆæœ¬éœ€è¦å¯¹ç…§ï¼Œå¹¶ä¸”åŸºäºPHP7 çš„ç¯å¢ƒ<br>
å¯¹ç…§å…³ç³»å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>Elasticsearch ç‰ˆæœ¬</th>
<th>Elasticsearch-PHP åˆ†æ”¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>&gt;= 6.0</td>
<td><code>6.0</code></td>
</tr>
<tr>
<td>&gt;= 5.0, â‡ 6.0</td>
<td><code>5.0</code></td>
</tr>
<tr>
<td>&gt;= 1.0, â‡ 5.0</td>
<td><code>1.0</code>, <code>2.0</code></td>
</tr>
<tr>
<td>â‡ 0.90.*</td>
<td><code>0.4</code></td>
</tr>
</tbody>
</table>
<h4 id="composer-å®‰è£…å¦‚ä¸‹">composer å®‰è£…å¦‚ä¸‹</h4>
<pre><code>// æ–¹å¼ä¸€
//compooser.jsonæ–‡ä»¶æ·»åŠ å¦‚ä¸‹ï¼Œåœ¨composer update
{
    &quot;require&quot;: {
        &quot;elasticsearch/elasticsearch&quot;: &quot;~6.0&quot;
    }
}

//æ–¹å¼äºŒ
//ç›´æ¥è¿è¡Œcomposerå‘½ä»¤è¡Œå®‰è£…
$ composer require elasticsearch/elasticsearch 5.0
</code></pre>
<p>æˆ‘è¿™è¾¹å½“å‰æ˜¯åœ¨ ThinkPHP5 æ¡†æ¶é‡Œé¢å®‰è£…çš„ï¼Œå®‰è£…ç»“æœå°±åœ¨ <code>vender</code> é‡Œé¢<br>
è¿™ä¸ªæ‰©å±•é‡Œé¢æœ‰ä¸ªå‡½æ•° <code>filter_var</code> æ˜¯å·²ç»å¯ç”¨çš„ï¼Œæ‰€ä»¥éœ€è¦å»æ‰ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-php"># elasticsearch/elasticsearch/src/Elasticsearch/ClientBuilder.php
. . .
/**
* @param string $host
*
* @return string
*/
private function prependMissingScheme($host)
{
    // if (!filter_var($host, FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED)) {
    //     $host = 'http://' . $host;
    // }
    if (empty(parse_url($host, PHP_URL_SCHEME))){
        $host = 'http://' . $host;
    }
    return $host;
}
</code></pre>
<p>ä½¿ç”¨æ ·ä¾‹ï¼š</p>
<pre><code>. . .
use Elasticsearch\ClientBuilder;
. . .
public function search(){
    try{
        $client = ClientBuilder::create()-&gt;build();
        $params = [
            'index' =&gt; 'task_source_extend',
            'type' =&gt; 'task_source_extend',  
        ];        
        $results = $client-&gt;search($params);
        var_dump(json_encode($results,true));
    }catch(\Exception $e){
        var_dump($e-&gt;getMessage());
    }
}
</code></pre>
<p>è¯¦ç»†ä½¿ç”¨è¯´æ˜å¦‚ä¸‹ï¼š<code>https://www.elastic.co/guide/cn/elasticsearch/php/current/_search_operations.html</code></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[supervisor å®‰è£…ä½¿ç”¨]]></title>
        <id>https://fujianfei1991.github.io/post/ce-shi/</id>
        <link href="https://fujianfei1991.github.io/post/ce-shi/">
        </link>
        <updated>2020-07-16T09:59:22.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>superviosræ˜¯ä¸€ä¸ªLinux/Unixç³»ç»Ÿä¸Šçš„è¿›ç¨‹ç›‘æ§å·¥å…·ï¼Œä»–/å¥¹upervisoræ˜¯ä¸€ä¸ªPythonå¼€å‘çš„é€šç”¨çš„è¿›ç¨‹ç®¡ç†ç¨‹åºï¼Œå¯ä»¥ç®¡ç†å’Œç›‘æ§Linuxä¸Šé¢çš„è¿›ç¨‹ï¼Œèƒ½å°†ä¸€ä¸ªæ™®é€šçš„å‘½ä»¤è¡Œè¿›ç¨‹å˜ä¸ºåå°daemonï¼Œå¹¶ç›‘æ§è¿›ç¨‹çŠ¶æ€ï¼Œå¼‚å¸¸é€€å‡ºæ—¶èƒ½è‡ªåŠ¨é‡å¯ã€‚ä¸è¿‡åŒdaemontoolsä¸€æ ·ï¼Œå®ƒä¸èƒ½ç›‘æ§daemonè¿›ç¨‹</p>
<h2 id="ç»„ä»¶">ç»„ä»¶</h2>
<ul>
<li>supervisord<br>
ä¸»è¿›ç¨‹,è´Ÿè´£ç®¡ç†è¿›ç¨‹çš„serverï¼Œå®ƒä¼šæ ¹æ®é…ç½®æ–‡ä»¶åˆ›å»ºæŒ‡å®šæ•°é‡çš„åº”ç”¨ç¨‹åºçš„å­è¿›ç¨‹ï¼Œç®¡ç†å­è¿›ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå¯¹crashçš„è¿›ç¨‹é‡å¯ï¼Œå¯¹è¿›ç¨‹å˜åŒ–å‘é€äº‹ä»¶é€šçŸ¥ç­‰ã€‚åŒæ—¶å†…ç½®web serverå’ŒXML-RPC Interfaceï¼Œè½»æ¾å®ç°è¿›ç¨‹ç®¡ç†ã€‚ã€‚è¯¥æœåŠ¡çš„é…ç½®æ–‡ä»¶åœ¨/etc/supervisor/supervisord.conf</li>
<li>supervisorctl<br>
å®¢æˆ·ç«¯çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œæä¾›ä¸€ä¸ªç±»ä¼¼shellçš„æ“ä½œæ¥å£ï¼Œé€šè¿‡å®ƒä½ å¯ä»¥è¿æ¥åˆ°ä¸åŒçš„supervisordè¿›ç¨‹ä¸Šæ¥ç®¡ç†å®ƒä»¬å„è‡ªçš„å­ç¨‹åºï¼Œå‘½ä»¤é€šè¿‡UNIX socketæˆ–è€…TCPæ¥å’ŒæœåŠ¡é€šè®¯ã€‚ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œå‘é€æ¶ˆæ¯ç»™supervisordï¼Œå¯ä»¥æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¯åœè¿›ç¨‹ï¼ŒæŸ¥çœ‹è¿›ç¨‹æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºï¼Œè¿œç¨‹æ“ä½œç­‰ã€‚æœåŠ¡ç«¯ä¹Ÿå¯ä»¥è¦æ±‚å®¢æˆ·ç«¯æä¾›èº«ä»½éªŒè¯ä¹‹åæ‰èƒ½è¿›è¡Œæ“ä½œã€‚</li>
<li>web server<br>
superviosræä¾›äº†web serveråŠŸèƒ½ï¼Œå¯é€šè¿‡webæ§åˆ¶è¿›ç¨‹(éœ€è¦è®¾ç½®[inet<em>http</em>server]é…ç½®é¡¹)ã€‚</li>
<li>XML-RPC interface<br>
XML-RPCæ¥å£ï¼Œ å°±åƒHTTPæä¾›WEB UIä¸€æ ·ï¼Œç”¨æ¥æ§åˆ¶supervisorå’Œç”±å®ƒè¿è¡Œçš„ç¨‹åºã€‚</li>
</ul>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>å½“å‰ç¯å¢ƒ <code>CentOS Linux release 7.7.1908 (Core)</code><br>
å®‰è£…æ–¹æ³•æœ‰å¤šç§ï¼š1ã€ä½¿ç”¨æºç å®‰è£…ï¼Œ2ã€ä½¿ç”¨yumå®‰è£…ï¼Œ3ã€ç”±äºæ˜¯ç”¨pythonå†™çš„ï¼Œæ‰€ä»¥è¿˜æä¾›ä¸€ä¸­ pip å®‰è£…çš„æ–¹å¼<br>
â€‹	1ã€æºç å®‰è£…</p>
<pre><code class="language-sh">wget https://pypi.python.org/packages/source/s/supervisor/supervisor-3.1.3.tar.gz
tar zxvf supervisor-3.1.3.tar.gz
cd supervisor-3.1.3
python setup.py install
</code></pre>
<p>â€‹	2ã€yumå®‰è£…</p>
<pre><code class="language-sh">yum install -y supervisor
</code></pre>
<p>â€‹	3ã€pipå®‰è£…ï¼ˆæˆ‘å½“å‰çš„pythonç¯å¢ƒæ˜¯2.7ï¼‰</p>
<pre><code class="language-sh">pip install supervisor
</code></pre>
<p>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè¿”å›ç‰ˆæœ¬å·å³å¯</p>
<pre><code class="language-sh">supervisord -v
</code></pre>
<h2 id="åŸºç¡€é…ç½®">åŸºç¡€é…ç½®</h2>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶</p>
<pre><code># echo_supervisord_conf &gt; /etc/supervisord.conf
</code></pre>
<p>åŸºç¡€é…ç½®æ–‡ä»¶ä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦æ›´æ”¹ï¼Œé™¤äº†æœ€åçš„ [include] éƒ¨åˆ†ï¼Œå…¶ä½™ä¿æŒé»˜è®¤å³å¯</p>
<h4 id="å­è¿›ç¨‹é…ç½®æ–‡ä»¶">å­è¿›ç¨‹é…ç½®æ–‡ä»¶</h4>
<p>ä¸€èˆ¬æ”¾åœ¨ï¼š<code>/etc/supervisord.d/</code> è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œä¸€ä¸ªè„šæœ¬å¯¹åº”ä¸€ä¸ªé…ç½®æ–‡ä»¶<br>
åœ¨ <code>/etc/supervisord.conf</code> å½“ä¸­ [include] é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œéœ€è¦æ‰“å¼€ä¸€ä¸‹</p>
<pre><code>. . .
# å¼€å¯ç½‘é¡µè®¿é—®
[inet_http_server]         ; inet (TCP) server disabled by default
port=0.0.0.0:9001        ; (ip_address:port specifier, *:port for all iface)
username=user              ; (default is no username (open server))
password=123               ; (default is no password (open server))
. . .
# è¿™é‡Œéœ€è¦æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥è®¾ç½®
[include]
files = /etc/supervisord.d/*.conf
</code></pre>
<p>æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨</p>
<pre><code># supervisord -c /etc/supervisord.conf
</code></pre>
<h2 id="é…ç½®å¼€æœºè‡ªå¯">é…ç½®å¼€æœºè‡ªå¯</h2>
<p>ç¼–è¾‘æœåŠ¡æ–‡ä»¶</p>
<pre><code class="language-sh"># vim /usr/lib/systemd/system/supervisord.service

# å†…å®¹å¦‚ä¸‹
[Unit]
Description=Supervisor daemon

[Service]
Type=forking
PIDFile=/var/run/supervisord.pid
ExecStart=/usr/bin/supervisord -c /etc/supervisord.conf
ExecStop=/usr/bin/supervisorctl shutdown
ExecReload=/usr/bin/supervisorctl reload
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
</code></pre>
<p>å¯åŠ¨æœåŠ¡</p>
<pre><code># systemctl enable supervisord
</code></pre>
<p>æŸ¥çœ‹æ˜¯å¦å¯åŠ¨</p>
<pre><code># systemctl is-enabled supervisord
enabled
</code></pre>
<p>ç®¡ç† <code>supervisor</code> æœåŠ¡</p>
<pre><code># systemctl stop supervisord
# systemctl start supervisord
# systemctl status supervisord
# systemctl reload supervisord
# systemctl restart supervisord
</code></pre>
<h2 id="å­è¿›ç¨‹ç®¡ç†">å­è¿›ç¨‹ç®¡ç†</h2>
<p>ä¸€èˆ¬æ”¾åœ¨ï¼š<code>/etc/supervisord.d/</code> è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œä¸€ä¸ªè„šæœ¬å¯¹åº”ä¸€ä¸ªé…ç½®æ–‡ä»¶<br>
** é…ç½®è¯´æ˜ **</p>
<pre><code>; åº”ç”¨åç§°ï¼Œå¿…å¡«
[program:echo_time]
; è¿›ç¨‹æ‰§è¡Œå‰ä¼šåˆ‡æ¢åˆ°æŒ‡å®šç›®å½•ä¸‹æ‰§è¡Œï¼Œé»˜è®¤ä¸åˆ‡æ¢ï¼Œéå¿…é¡»
directory = /tmp
; å¯åŠ¨ä¼˜å…ˆçº§ï¼Œé»˜è®¤-1
priority = -1
; å­è¿›ç¨‹æ“ä½œå‘½ä»¤ï¼Œæœ€åå¸¦ä¸Šå®Œæ•´è·¯å¾„
command=sh /tmp/echo_time.sh
;  å­è¿›ç¨‹æ˜¯å¦è¢«è‡ªåŠ¨å¯åŠ¨
autostart=true
; è¿™ä¸ªæ˜¯è®¾ç½®å­è¿›ç¨‹æŒ‚æ‰åè‡ªåŠ¨é‡å¯çš„æƒ…å†µï¼Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œfalse,unexpectedå’Œtrueã€‚å¦‚æœä¸ºfalseçš„æ—¶å€™ï¼Œæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹ï¼Œéƒ½ä¸ä¼šè¢«é‡æ–°å¯åŠ¨ï¼Œå¦‚æœä¸ºunexpectedï¼Œåªæœ‰å½“è¿›ç¨‹çš„é€€å‡ºç ä¸åœ¨ä¸‹é¢exitcodesé‡Œé¢å®šä¹‰çš„é€€å‡ºç çš„æ—¶å€™ï¼Œæ‰ä¼šè¢«è‡ªåŠ¨é‡å¯ã€‚å½“ä¸ºtrueçš„æ—¶å€™ï¼Œåªè¦å­è¿›ç¨‹æŒ‚æ‰ï¼Œå°†ä¼šè¢«æ— æ¡ä»¶çš„é‡å¯
autorestart=true
; å­è¿›ç¨‹å¯åŠ¨å‡ ç§’åè¢«è®¤ä¸ºå¯åŠ¨æˆåŠŸ
startsecs=10
; å­è¿›ç¨‹å¯åŠ¨å¤±è´¥åï¼Œæœ€å¤§å°è¯•é‡æ–°å¯åŠ¨æ¬¡æ•°
startretries=3 
; å­è¿›ç¨‹é€€å‡ºç ï¼Œæ³¨æ„å’Œä¸Šé¢çš„autorestart=unexpected ç›¸å¯¹åº”ï¼Œexitcodesé‡Œé¢å®šä¹‰çš„é€€å‡ºç æ˜¯expected çš„ï¼Œå…³äºè¿™ä¸ªå­è¿›ç¨‹é€€å‡ºç è¿˜æ˜¯éœ€è¦å†äº†è§£ä¸‹
exitcodes=0,2
; è¿›ç¨‹åœæ­¢ä¿¡å·ï¼Œå¯ä»¥ä¸ºTERM, HUP, INT, QUIT, KILL, USR1, or USR2 ç­‰ä¿¡å·ï¼Œé»˜è®¤ä¸º TERMï¼Œå½“ç”¨è®¾å®šçš„ä¿¡å·å»å¹²æ‰°è¿›ç¨‹ï¼Œé€€å‡ºç ä¼šè¢«è®¤ä¸ºæ˜¯expectedï¼Œéå¿…é¡»è®¾ç½®
stopsignal=QUIT
; å½“å‘å­è¿›ç¨‹å‘é€ stopsignalä¿¡å·åï¼Œåˆ°ç³»ç»Ÿè¿”å›ä¿¡æ¯ç»™supervisor æ‰€ç­‰å¾…çš„æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œsupervisorä¼šå‘è¯¥å­è¿›ç¨‹å‘é€ä¸€ä¸ªå¼ºåˆ¶ kill çš„ä¿¡å·ï¼Œé»˜è®¤ 10 ç§’ï¼Œéå¿…é¡»è®¾ç½®
stopwaitsecs=10
; å¯åŠ¨çš„ç”¨æˆ·
user=root
; æ—¥å¿—å¼€å¯
log_stdout=true
; æ—¥å¿—é”™è¯¯å¼€å¯
log_stderr=true
; å­è¿›ç¨‹æ—¥å¿—
logfile=/tmp/echo_time.log
; å•æ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å°ï¼Œé»˜è®¤æ˜¯50Mï¼Œå½“è¶…è¿‡æ—¶ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè®¾ç½®ä¸º0æ—¶è¡¨ç¤ºä¸é™åˆ¶å¤§å°
logfile_maxbytes=1MB
; æ—¥å¿—æ–‡ä»¶ä¿æŒçš„æ•°é‡ï¼Œä¸Šé¢çš„æ—¥å¿—æ–‡ä»¶è¶…è¿‡é™å®šæ—¶ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå½“æ–‡ä»¶æ•°é‡å¤§äºé™åˆ¶æ•°é‡æ—¶ï¼Œæœ€åˆçš„è€æ–‡ä»¶ä¼šè¢«æ–°æ–‡ä»¶è¦†ç›–ï¼Œæ–‡ä»¶æ•°é‡å°†ä¿æŒä¸å˜ï¼Œå½“è®¾ç½®ä¸º0æ—¶ï¼Œè¡¨ç¤ºä¸é™åˆ¶æ–‡ä»¶çš„æ•°é‡ï¼Œé»˜è®¤ä¸º10ï¼Œéå¿…é¡»è®¾ç½®
logfile_backups=10
 ; stdoutæ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å°ï¼Œå±æ€§åŒä¸Š
stdout_logfile_maxbytes=20MB 
; stdout æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼Œå±æ€§åŒä¸Š
stdout_logfile_backups=20 
; stdout æ—¥å¿—æ–‡ä»¶ä½ç½®
stdout_logfile=/tmp/echo_time.stdout.log
</code></pre>
<h2 id="ä½¿ç”¨æ ·ä¾‹">ä½¿ç”¨æ ·ä¾‹</h2>
<p>è„šæœ¬æ–‡ä»¶ <code>/tmp/echo_time.sh</code><br>
** å†…å®¹å¦‚ä¸‹ï¼š**</p>
<pre><code>#/bin/bash
while true; do
    echo `date + %Y-%m-%d,%H:%m:%s`
    sleep 2
done
</code></pre>
<p>åœ¨ <code>/etc/supervisor.d</code> å½“ä¸­æ–°å¢å­è¿›ç¨‹é…ç½®æ–‡ä»¶ <code>echo_time.conf</code> , å†…å®¹å¦‚ä¸‹</p>
<pre><code>[program:echo_time]
command=sh /tmp/echo_time.sh  ; å¯åŠ¨å‘½ä»¤
priority=999                ; the relative start priority (default 999)
autostart=true              ; start at supervisord start (default: true)
autorestart=true            ; retstart at unexpected quit (default: true)
startsecs=10                ; number of secs prog must stay running (def. 10)
startretries=3              ; max # of serial start failures (default 3)
exitcodes=0,2               ; 'expected' exit codes for process (default 0,2)
stopsignal=QUIT             ; signal used to kill process (default TERM)
stopwaitsecs=10             ; max num secs to wait before SIGKILL (default 10)
user=root                 ; setuid to this UNIX account to run the program
log_stdout=true
log_stderr=true             ; if true, log program stderr (def false)
logfile=/tmp/echo_time.log
logfile_maxbytes=1MB        ; max # logfile bytes b4 rotation (default 50MB)
logfile_backups=10          ; # of logfile backups (default 10)
stdout_logfile_maxbytes=20MB  ; stdout æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ 50MB
stdout_logfile_backups=20     ; stdout æ—¥å¿—æ–‡ä»¶å¤‡ä»½æ•°
stdout_logfile=/tmp/echo_time.stdout.log
</code></pre>
<p>ä¿å­˜ä¹‹åé‡æ–°å¯åŠ¨ç¨‹åºï¼ŒåŠ è½½é…ç½®ä¿¡æ¯</p>
<pre><code># supervisorctl reread    # é‡æ–°è¯»å–é…ç½®
# supervisorctl update   # æ›´æ–°å­è¿›ç¨‹
</code></pre>
<p>æ‰§è¡Œ <code>update</code> åè¾“å‡º</p>
<pre><code>echo_time: added process group
</code></pre>
<p>å¯ä»¥é€šè¿‡æ—¥å¿—æˆ–è€…<code>supervisorctl status</code> æŸ¥çœ‹å­è¿›ç¨‹è¿è¡Œæƒ…å†µ</p>
<pre><code># supervisorctl  status
echo_time                        RUNNING   pid 5542, uptime 0:00:11
</code></pre>
<p>ç”±äºæˆ‘è¿™è¾¹å¯ç”¨äº†å¼€æœºè‡ªå¯çš„æœåŠ¡ï¼Œæ‰€ä»¥è¿˜å¯ä»¥æ‰§è¡Œ <code>systemctl status supervisord</code> æŸ¥çœ‹</p>
<pre><code># systemctl status supervisord
â— supervisord.service - Supervisor daemon
   Loaded: loaded (/usr/lib/systemd/system/supervisord.service; enabled; vendor preset: disabled)
   Active: activating (auto-restart) (Result: exit-code) since Fri 2020-07-17 11:29:27 CST; 31s ago
  Process: 5678 ExecStart=/bin/supervisord -c /etc/supervisord.conf (code=exited, status=2)
   CGroup: /system.slice/supervisord.service
           â”œâ”€ 5542 sh /tmp/echo_time.sh  # æ­¤å¤„å°±æ˜¯å­è¿›ç¨‹çš„PID
           â”œâ”€ 5737 sleep 2
           â””â”€15349 /usr/bin/python /usr/bin/supervisord -c /etc/supervisord.conf
</code></pre>
<p>åœ¨ç½‘é¡µå½“ä¸­ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ° å­è¿›ç¨‹çš„çŠ¶æ€<br>
<img src="https://fujianfei1991.github.io/post-images/1594966890823.png" alt="" loading="lazy"></p>
<h2 id="supervisor-å®šæœŸé‡å¯æŒ‡å®šè¿›ç¨‹">supervisor å®šæœŸé‡å¯æŒ‡å®šè¿›ç¨‹</h2>
<p>å¯ä»¥åˆ©ç”¨ <code>crontab</code> æ¥å®ç°å®šæœŸä»»åŠ¡ï¼Œè®¾ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>## å‡å¦‚æ¯å¤©æ—©ä¸Š6ç‚¹é‡å¯ä¸€ä¸ªè¿›ç¨‹ aaaï¼Œè¿™é‡Œçš„aaa å°±æ˜¯é…ç½®åœ¨supervisoré‡Œé¢çš„è¿›ç¨‹åç§°
0 6 * * *  supervisorctl -c /etc/supervisord.conf restart aaa
</code></pre>
<p>å½“å¯¹äºæŸäº›ä¼šå‡ºç°å†…å­˜æ³„æ¼æˆ–è¿æ¥ä¸è‡ªåŠ¨é‡Šæ”¾çš„è¿›ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸Šæ–¹æ³•è¿›è¡Œå®šæœŸé‡å¯ï¼Œè§£å†³å†…å­˜æ³„æ¼åŠé‡Šæ”¾è¿æ¥æ•°ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://fujianfei1991.github.io/post/hello-gridea/</id>
        <link href="https://fujianfei1991.github.io/post/hello-gridea/">
        </link>
        <updated>2018-12-11T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="https://gridea.dev/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>Windows</strong>ï¼Œ<strong>MacOS</strong> æˆ– <strong>Linux</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>